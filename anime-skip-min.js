!function(){"use strict";const e="https://api.aniskip.com/v2/skip-times",t="https://api.jikan.moe/v4/anime",i=["op","ed","recap"];function n(e,t=!1){console.log("[UltimateSkip]: "+e),t&&"undefined"!=typeof Lampa&&Lampa.Noty}function a(e,t){if(!e||"object"!=typeof e)return 0;e.segments=e.segments||{},e.segments.skip=e.segments.skip||[];let i=0;return t.forEach((t=>{e.segments.skip.some((e=>e.start===t.start))||(e.segments.skip.push({start:t.start,end:t.end,name:t.name||"Пропустить"}),i++)})),i}async function s(s){let o=s.movie||s.card;if(!o){const e=Lampa.Activity.active();e&&(o=e.movie||e.card)}if(!o)return;const r=o.kinopoisk_id||("kinopoisk"===o.source?o.id:null)||o.kp_id,l=function(e,t=1){if(e.episode||e.e||e.episode_number)return{season:parseInt(e.season||e.s||t),episode:parseInt(e.episode||e.e||e.episode_number)};if(e.playlist&&Array.isArray(e.playlist)){const i=e.url,n=e.playlist.findIndex((e=>e.url&&e.url===i));if(-1!==n){const i=e.playlist[n];return{season:parseInt(i.season||i.s||t),episode:n+1}}}return{season:t,episode:1}}(s,1);let p=l.episode,c=l.season;const d=o.number_of_seasons>0||o.original_name&&!o.original_title;d||(c=1,p=1),n(`Start search for: ${o.title} (S${c} E${p}) [Method: calculated]`),console.log("[UltimateSkip DEBUG] Search Params:",{kpId:r,season:c,episode:p,isSerial:d});const m=(o.original_language||"").toLowerCase(),u="ja"===m||"zh"===m||"cn"===m,g=o.genres&&o.genres.some((e=>16===e.id||e.name&&"animation"===e.name.toLowerCase()));if(u||g){n("Anime criteria matched. Trying AniSkip...");let r=o.original_name||o.original_title||o.name;const l=r?r.replace(/\(\d{4}\)/g,"").replace(/\(TV\)/gi,"").replace(/Season \d+/gi,"").replace(/Part \d+/gi,"").replace(/[:\-]/g," ").replace(/\s+/g," ").trim():"";console.log(`[UltimateSkip DEBUG] Cleaned title: "${l}"`);const d=(o.release_date||o.first_air_date||"0000").slice(0,4),m=await async function(e,i,a){let s=e;i>1&&(s+=" Season "+i);const o=`${t}?q=${encodeURIComponent(s)}&limit=10`;console.log("[UltimateSkip DEBUG] Jikan URL:",o);try{const e=await fetch(o),t=await e.json();if(!t.data||0===t.data.length)return null;if(a&&1===i){const e=t.data.find((e=>{let t=e.year;return!t&&e.aired&&e.aired.from&&(t=e.aired.from.substring(0,4)),String(t)===String(a)}));if(e)return console.log(`[UltimateSkip DEBUG] Found by year (${a}): ${e.title} (ID: ${e.mal_id})`),e.mal_id}if(i>1){const e=[`Season ${i}`,`${i+(i%10==1&&11!==i?"st":i%10==2&&12!==i?"nd":i%10==3&&13!==i?"rd":"th")} Season`,`Season${i}`];console.log("[UltimateSkip DEBUG] Checking titles for keywords:",e);const n=t.data.find((t=>[t.title,t.title_english,...t.title_synonyms||[]].filter(Boolean).map((e=>e.toLowerCase())).some((t=>e.some((e=>t.includes(e.toLowerCase())))))));if(n)return console.log(`[UltimateSkip DEBUG] Found by title keywords: ${n.title} (ID: ${n.mal_id})`),n.mal_id}return console.log(`[UltimateSkip DEBUG] Fallback to first result: ${t.data[0].title} (ID: ${t.data[0].mal_id})`),t.data[0].mal_id}catch(e){return n("Jikan Error: "+e.message),null}}(l,c,d);if(m){console.log(`[UltimateSkip DEBUG] Selected MAL ID: ${m}`);const t=function(e){if(!e||!e.length)return[];const t=[];return e.forEach((e=>{if(!e.interval)return;const i=(e.skipType||e.skip_type||"").toLowerCase();let n="Пропустить";i.includes("op")?n="Опенинг":i.includes("ed")?n="Эндинг":"recap"===i&&(n="Рекап");const a=void 0!==e.interval.startTime?e.interval.startTime:e.interval.start_time,s=void 0!==e.interval.endTime?e.interval.endTime:e.interval.end_time;void 0!==a&&void 0!==s&&t.push({start:a,end:s,name:n})})),t}(await async function(t,n){const a=i.map((e=>"types="+e));a.push("episodeLength=0");const s=`${e}/${t}/${n}?${a.join("&")}`;console.log("[UltimateSkip DEBUG] AniSkip URL:",s);try{const e=await fetch(s);if(404===e.status)return[];const t=await e.json();return t.found&&t.results&&t.results.length>0?(console.log(`[UltimateSkip DEBUG] AniSkip segments found: ${t.results.length}`),t.results):[]}catch(e){return console.log("[UltimateSkip DEBUG] AniSkip Error:",e),[]}}(m,p));t.length>0?(a(s,t),f=s.playlist,k=c,y=p,S=t,f&&Array.isArray(f)&&f.forEach(((e,t)=>{const i=e.season||e.s||k,n=e.episode||e.e||e.episode_number||t+1;parseInt(n)===parseInt(y)&&parseInt(i)===parseInt(k)&&a(e,S)})),Lampa.Noty.show("Таймкоды загружены: Сезон "+c+", Серия "+p),window.Lampa.Player.listener&&window.Lampa.Player.listener.send("segments",{skip:s.segments.skip}),n("[Success] Found in AniSkip")):n("AniSkip returned no segments.")}else n("Jikan ID not found.")}else n("Not an Anime (Language/Genre mismatch). Skipping AniSkip.");var f,k,y,S}function o(){if(window.lampa_ultimate_skip)return;window.lampa_ultimate_skip=!0;const e=Lampa.Player.play;Lampa.Player.play=function(t){const i=this;Lampa.Loading.start((()=>{Lampa.Loading.stop(),e.call(i,t)})),s(t).then((()=>{Lampa.Loading.stop(),e.call(i,t)})).catch((n=>{console.error("[UltimateSkip] Critical Error:",n),Lampa.Loading.stop(),e.call(i,t)}))},console.log("[UltimateSkip] AniSkip Plugin Loaded")}window.Lampa&&window.Lampa.Player?o():window.document.addEventListener("app_ready",o)}();
