!function(){"use strict";const e="https://api.aniskip.com/v2/skip-times",t="https://api.jikan.moe/v4/anime",i=["op","ed","recap"];function n(e,t=!1){console.log("[UltimateSkip]: "+e),t&&"undefined"!=typeof Lampa&&Lampa.Noty}function a(e,t){if(!e||"object"!=typeof e)return 0;e.segments||(e.segments={}),e.segments.skip||(e.segments.skip=[]);let i=0;return t.forEach((t=>{e.segments.skip.some((e=>e.start===t.start))||(e.segments.skip.push({start:t.start,end:t.end,name:t.name||"Пропустить"}),i++)})),i}async function s(s){let o=s.movie||s.card;if(!o){const e=Lampa.Activity.active();e&&(o=e.movie||e.card)}if(!o)return;const r=o.kinopoisk_id||("kinopoisk"===o.source?o.id:null)||o.kp_id,l=function(e,t=1){if(e.episode||e.e||e.episode_number)return{season:parseInt(e.season||e.s||t),episode:parseInt(e.episode||e.e||e.episode_number)};if(e.playlist&&Array.isArray(e.playlist)){const i=e.url,n=e.playlist.findIndex((e=>e.url&&e.url===i));if(-1!==n){const i=e.playlist[n];return{season:parseInt(i.season||i.s||t),episode:n+1}}}return{season:t,episode:1}}(s,1);let p=l.episode,c=l.season;const m=o.number_of_seasons>0||o.original_name&&!o.original_title;m||(c=1,p=1),n(`Start search for: ${o.title} (S${c} E${p}) [Method: ${l.method||"calculated"}]`),console.log("[UltimateSkip DEBUG] Card Data:",o),console.log("[UltimateSkip DEBUG] Search Params:",{kpId:r,currentSeason:c,currentEpisode:p,isSerial:m});const d=(o.original_language||"").toLowerCase(),u="ja"===d||"zh"===d||"cn"===d,g=o.genres&&o.genres.some((e=>16===e.id||e.name&&"animation"===e.name.toLowerCase()));if(u||g){let r;n("Anime criteria matched. Trying AniSkip...");const l=(r=o.original_name||o.original_title||o.name)?r.replace(/\(\d{4}\)/g,"").replace(/\(TV\)/gi,"").replace(/Season \d+/gi,"").replace(/Part \d+/gi,"").replace(/[:\-]/g," ").replace(/\s+/g," ").trim():"",m=(o.release_date||o.first_air_date||"0000").slice(0,4),d=await async function(e,i,a){let s=e;i>1&&(s+=" Season "+i);const o=`${t}?q=${encodeURIComponent(s)}&limit=10`;console.log("[UltimateSkip DEBUG] Jikan Search URL:",o);try{const e=await fetch(o),t=await e.json();if(console.log("[UltimateSkip DEBUG] Jikan Response:",t),!t.data||0===t.data.length)return null;if(a){const e=t.data.find((e=>{let t=e.year;return!t&&e.aired&&e.aired.from&&(t=e.aired.from.substring(0,4)),String(t)===String(a)}));if(e)return console.log(`[UltimateSkip DEBUG] Jikan found matched year ${a}: ID ${e.mal_id} (${e.title})`),e.mal_id}return console.log(`[UltimateSkip DEBUG] Jikan year match failed. Using first result: ID ${t.data[0].mal_id}`),t.data[0].mal_id}catch(e){return n("Jikan Error: "+e.message),console.log("[UltimateSkip DEBUG] Jikan Exception:",e),null}}(l,c,m);if(d){const t=await async function(t,n){const a=i.map((e=>"types="+e));a.push("episodeLength=0");const s=`${e}/${t}/${n}?${a.join("&")}`;console.log("[UltimateSkip DEBUG] AniSkip URL:",s);try{const e=await fetch(s);if(404===e.status)return console.log("[UltimateSkip DEBUG] AniSkip 404 Not Found"),[];const t=await e.json();return console.log("[UltimateSkip DEBUG] AniSkip Response:",t),t.found&&t.results||[]}catch(t){return console.log("[UltimateSkip DEBUG] AniSkip Error:",t),[]}}(d,p),r=function(e){if(!e||!e.length)return[];const t=[];return e.forEach((e=>{if(!e.interval)return;const i=(e.skipType||e.skip_type||"").toLowerCase();let n="Пропустить";i.includes("op")?n="Опенинг":i.includes("ed")?n="Эндинг":"recap"===i&&(n="Рекап");const a=void 0!==e.interval.startTime?e.interval.startTime:e.interval.start_time,s=void 0!==e.interval.endTime?e.interval.endTime:e.interval.end_time;void 0!==a&&void 0!==s&&t.push({start:a,end:s,name:n})})),t}(t);if(r.length>0)return n("[Success] Found in AniSkip"),a(s,r),function(e,t,i,n){e&&Array.isArray(e)&&e.forEach(((e,s)=>{const o=e.season||e.s||t,r=e.episode||e.e||e.episode_number||s+1;parseInt(r)===parseInt(i)&&parseInt(o)===parseInt(t)&&a(e,n)}))}(s.playlist,c,p,r),Lampa.Noty.show("Таймкоды: "+o.title+" (S"+c+" E"+p+")"),void(window.Lampa.Player.listener&&window.Lampa.Player.listener.send("segments",{skip:s.segments.skip}));n("AniSkip returned no segments.")}else n("Jikan ID not found.")}else n("Not an Anime (Language/Genre mismatch). Skipping AniSkip.")}function o(){if(window.lampa_ultimate_skip)return;window.lampa_ultimate_skip=!0;const e=Lampa.Player.play;Lampa.Player.play=function(t){const i=this;Lampa.Loading.start((()=>{Lampa.Loading.stop(),e.call(i,t)})),s(t).then((()=>{Lampa.Loading.stop(),e.call(i,t)})).catch((n=>{console.error("[UltimateSkip] Critical Error:",n),Lampa.Loading.stop(),e.call(i,t)}))},console.log("[UltimateSkip] AniSkip Plugin Loaded")}window.Lampa&&window.Lampa.Player?o():window.document.addEventListener("app_ready",o)}();
